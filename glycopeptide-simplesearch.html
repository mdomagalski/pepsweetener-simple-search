<!-- Imports polymer -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../glycopeptide-multiresult/glycopeptide-multiresult.html">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<!-- Defines element markup -->
<dom-module id="glycopeptide-simplesearch">
    <style is="simplesearch-style">
        paper-header-panel {
            width: 100%;
        }
        paper-toolbar {
            color: #424242;
            transition: height 450ms cubic-bezier(0.55, 0, 0.1, 1);
            display: block;
            position: relative;
            box-sizing: border-box;
            -moz-box-sizing: border-box;
            height: auto;
            background: #fafafa;
            color: #424242;
            padding: 20px 0px 20px 10%;
        }
        paper-input {
            min-width: 300px;
            width: 300px;
            display: inline-block;
            margin: 20px 10px 30px 80px;
        }
        paper-button.indigo {
            font-family: "Roboto";
            background-color: var(--paper-indigo-500);
            color: white;
            --paper-button-raised-keyboard-focus: {
                background-color: var(--paper-indigo-a300) !important;
                color: white !important;
            };
        }
    </style>
    <template>
        <iron-ajax
            id="ajax"
            method="POST"
            url="{{url}}"
            handle-as="json"
            on-response="handleResponse"
            debounce-duration="300">
        </iron-ajax>
        <div class="panel-group">
            <div class="panel panel-primary">
                <div class="panel-heading">Find theoretical N-glycopeptides</div>
                <div class="panel-body">
                <form is="iron-form" id="simpleSearchForm">
                    <paper-input name="masses" label="List of Masses (Da)" value="{{masses}}"></paper-input>
                    <paper-input name="ppm" label="tolerance (ppm)" value="{{ppm}}"></paper-input>
                    <paper-button raised class="indigo" on-click="search">search</paper-button>
                </form>
                </div>
            </div>
        </div>
        <glycopeptide-multiresult id="results"></glycopeptide-multiresult>
    </template>

    <!-- Registers custom element -->
    <script>
    Polymer({
        is: 'glycopeptide-simplesearch',
        properties: {
            url: {
                type: String,
                value: "http://localhost:8080/search"
            },
            masses: String,
            ppm: {
                type: Number,
                value: 10
            },
            errorMessage: {
                type: String,
                value: "Please check your query"
            }
        },
        search: function(){
            var queryList = this.masses.split(",").filter(Number);
            for(var i=0; i<queryList.length; i++){queryList[i] = queryList[i].trim()};

            var nonRedundantQueryList = queryList.filter(function(item, pos) {
                return queryList.indexOf(item) == pos;
            });
            var multiResultElement = Polymer.dom(this.root).querySelector('#results');
            multiResultElement.masses = nonRedundantQueryList;
            for(mass of nonRedundantQueryList){
                this.$.ajax.params = '{"mass": "'+mass+'", "ppm": "'+this.ppm+'"}';
                this.$.ajax.generateRequest();
            }
        },
        handleResponse: function(request, response) {
            response = request.detail.response;
            var multiResultElement = Polymer.dom(this.root).querySelector('#results');
            multiResultElement.newDataset(response);
        }
    });
    </script>
</dom-module>
